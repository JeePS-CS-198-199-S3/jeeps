import random
from google.cloud import firestore_v1
import firebase_admin
from firebase_admin import credentials
from firebase_admin import firestore
import time
import math

# Set the path to your service account key JSON file
cred = credentials.Certificate("D:\CS 145\TransiTrack\simulation\Transitrack.json")

firebase_admin.initialize_app(cred)
db = firestore.client()

# Define the collection and document names
collection_name = 'jeeps_realtime'


ikot = [
    [14.657675, 121.062360],
    [14.654756, 121.062316],
    [14.647361, 121.062336],
    [14.647706, 121.063844],
    [14.647659, 121.064632],
    [14.647939, 121.065780],
    [14.647960, 121.066328],
    [14.647254, 121.067808],
    [14.647173, 121.068955],
    [14.649071, 121.068951],
    [14.649904, 121.068611],
    [14.650504, 121.068453],
    [14.650908, 121.068430],
    [14.651842, 121.068584],
    [14.652487, 121.068667],
    [14.652550, 121.072847],
    [14.653974, 121.072828],
    [14.654645, 121.073132],
    [14.655566, 121.073090],
    [14.656308, 121.072771],
    [14.659379, 121.072722],
    [14.659390, 121.068572],
    [14.657539, 121.068584],
    [14.657568, 121.064787]
]

toki = [
    [14.652960309655244, 121.06229032368765],
    [14.657700291994187, 121.06234135892598],
    [14.65758302807958, 121.06477191187733],
    [14.657564512713318, 121.06856765705194],
    [14.659422213350918, 121.06854213952413],
    [14.659403698143263, 121.07271426978609],
    [14.657539825575478, 121.0727270285947],
    [14.65752131020559, 121.07274616680566],
    [14.657595371675777, 121.07432187950842],
    [14.652598620788039, 121.07429579367411],
    [14.652572671022089, 121.07283667206927],
    [14.651996585405042, 121.0727508413746],
    [14.650932639544383, 121.07128635535467],
    [14.650392879635199, 121.07124343999037],
    [14.650377309619284, 121.07206419589308],
    [14.650574529739076, 121.07369497886316],
    [14.648290917483044, 121.07380226721646],
    [14.648181926282877, 121.07242361182773],
    [14.647315184971722, 121.07080355769295],
    [14.647201003219504, 121.06894746912985],
    [14.648908533117885, 121.06897965563581],
    [14.650159329261273, 121.06849149352905],
    [14.651197328974687, 121.06843784933488],
    [14.652505201561508, 121.06866851929449],
    [14.652276829185512, 121.06776727189317],
    [14.651788972355082, 121.06703771109078],
    [14.651290734450155, 121.06679631228383],
    [14.650444765448706, 121.06683386320748],
    [14.650169695053597, 121.06679094785812],
    [14.649640313353062, 121.06610430239702],
    [14.648161151810301, 121.06599701403938],
    [14.649640313353062, 121.06610430239702],
    [14.650169695053597, 121.06679094785812],
    [14.650444765448706, 121.06683386320748],
    [14.650496665475096, 121.06676412577127],
    [14.651897961713848, 121.06505287653621],
    [14.652993042573604, 121.06524063112236],
    [14.65309679530806, 121.06510112416251],
    [14.652935908229038, 121.06234378834203],
    [14.652960309655244, 121.06229032368765]
]

katip = [
    [14.6323447623831, 121.074405213629],
    [14.6326825733295, 121.074422244595],
    [14.6329482901109, 121.074437146691],
    [14.6333767320084, 121.074426502336],
    [14.6365860234475, 121.074533239344],
    [14.6385678787093, 121.074616690075],
    [14.6420837926593, 121.07476083228],
    [14.6432251680955, 121.074817730516],
    [14.643632538575, 121.074806350867],
    [14.6439665084156, 121.074798764428],
    [14.6444362673135, 121.074707727235],
    [14.6451652588312, 121.074602570179],
    [14.646083950015, 121.074495311361],
    [14.6465758942317, 121.074474715092],
    [14.647220718189, 121.074477998259],
    [14.6486183596855, 121.074517396277],
    [14.6494381400028, 121.074518387762],
    [14.651088562606, 121.074513023344],
    [14.6523808660169, 121.074480836878],
    [14.6534188551666, 121.074513023384],
    [14.6543893706103, 121.074620311773],
    [14.6549395004294, 121.074582760849],
    [14.657534433826, 121.074577396454],
    [14.6575673394275, 121.07272185565],
    [14.6593848545115, 121.072739919679],
    [14.6594198065771, 121.068561099031],
    [14.6575323870741, 121.068555077629],
    [14.6577043643201, 121.062401754888],
    [14.6529648884757, 121.062302514649],
    [14.6530434441401, 121.065144393935],
    [14.6517778213417, 121.067011914714],
    [14.6522142438102, 121.067670508964],
    [14.6524235482375, 121.068239092347],
    [14.6524767210812, 121.068671605683],
    [14.6525801531953, 121.074303311717],
    [14.6471529029232, 121.074279423725],
    [14.644376652189, 121.074527072591],
    [14.6434379992996, 121.074608318195],
    [14.6405988966819, 121.074488839371],
    [14.6317717235596, 121.073976135937],
    [14.6323447623831, 121.074405213629]
]

philcoa = [
    [14.6543299972606, 121.054873663637],
    [14.6547305, 121.0569347],
    [14.6547536, 121.0587669],
    [14.6547951, 121.0623267],
    [14.6529527, 121.0622999],
    [14.6530461, 121.0651109],
    [14.6517797, 121.0670528],
    [14.6521933, 121.0675808],
    [14.6524113, 121.0682192],
    [14.6524684, 121.0686645],
    [14.6525354, 121.0716758],
    [14.6539211, 121.071662],
    [14.6539471, 121.0727724],
    [14.6545751, 121.0731157],
    [14.6555672, 121.0731061],
    [14.6561848, 121.0727735],
    [14.6593973, 121.0727198],
    [14.6594025, 121.0685467],
    [14.6575445, 121.0685736],
    [14.6575757, 121.0647927],
    [14.6576276, 121.0641865],
    [14.6576847, 121.0623465],
    [14.6549673, 121.0623251],
    [14.6548585, 121.0566478],
    [14.6549401, 121.0558828],
    [14.6550491, 121.0556897],
    [14.6552463, 121.0555502],
    [14.65681, 121.0579307],
    [14.6569319, 121.0580728],
    [14.657098, 121.0580353],
    [14.6572381, 121.0578824],
    [14.6571188, 121.0576759],
    [14.6529661, 121.0514811],
    [14.6527122840003, 121.051647277721],
    [14.6535123096324, 121.052838347635],
    [14.6541398506173, 121.054000968372],
    [14.653976543341, 121.054507362723],
    [14.6539448581879, 121.054570304295],
    [14.6542710808458, 121.054856747689],
    [14.6543299972606, 121.054873663637],
    [14.6542710808458, 121.054856747689],
    [14.6539448581879, 121.054570304295],
    [14.6537299219192, 121.054686460463],
    [14.6535400795614, 121.054171087901]
]


sm = [
    [14.6542219, 121.0543598],
    [14.6547305, 121.0569347],
    [14.6547536, 121.0587669],
    [14.6547951, 121.0623267],
    [14.6529527, 121.0622999],
    [14.6530461, 121.0651109],
    [14.6517797, 121.0670528],
    [14.6521933, 121.0675808],
    [14.6524113, 121.0682192],
    [14.6524684, 121.0686645],
    [14.6525354, 121.0716758],
    [14.6539211, 121.071662],
    [14.6539471, 121.0727724],
    [14.6545751, 121.0731157],
    [14.6555672, 121.0731061],
    [14.6561848, 121.0727735],
    [14.6593973, 121.0727198],
    [14.6594025, 121.0685467],
    [14.6575445, 121.0685736],
    [14.6575757, 121.0647927],
    [14.6576276, 121.0641865],
    [14.6576847, 121.0623465],
    [14.6549673, 121.0623251],
    [14.6548585, 121.0566478],
    [14.6549401, 121.0558828],
    [14.6550491, 121.0556897],
    [14.6552463, 121.0555502],
    [14.65681, 121.0579307],
    [14.6569319, 121.0580728],
    [14.657098, 121.0580353],
    [14.6572381, 121.0578824],
    [14.6571188, 121.0576759],
    [14.6529661, 121.0514811],
    [14.6531132, 121.0512071],
    [14.6535388, 121.0508691],
    [14.6540422, 121.0501878],
    [14.6544522, 121.0491847],
    [14.6544765, 121.0484651],
    [14.6541859, 121.0476336],
    [14.653589, 121.0469523],
    [14.6527291, 121.0466258],
    [14.652262, 121.0459713],
    [14.6553994, 121.0316384],
    [14.6556734, 121.031743],
    [14.6557175, 121.0316948],
    [14.655445, 121.0315741],
    [14.6556007, 121.0307479],
    [14.6555203, 121.0306567],
    [14.6554632, 121.0306889],
    [14.6537326, 121.0384553],
    [14.6492329, 121.0392278],
    [14.6461204, 121.0407885],
    [14.6435908, 121.0430332],
    [14.6412033, 121.0468741],
    [14.6482756, 121.0486665],
    [14.6485454, 121.0492835],
    [14.6485091, 121.0499862],
    [14.6487219, 121.0507587],
    [14.649272, 121.0514346],
    [14.6503337, 121.0519819],
    [14.6501546, 121.0536207],
    [14.6516597, 121.0535027],
    [14.65276, 121.0531165],
    [14.6533413, 121.0525693],
    [14.6542185, 121.0541626],
    [14.6542219, 121.0543598]
]


def calculate_bearing(coordinate1, coordinate2):
    x1, y1 = coordinate1
    x2, y2 = coordinate2

    delta_x = x2 - x1
    delta_y = y2 - y1

    bearing = math.atan2(delta_y, delta_x)
    bearing_degrees = math.degrees(bearing)

    # Adjust the bearing to be in the range of 0 to 360 degrees
    bearing_degrees = (bearing_degrees + 360) % 360

    return bearing_degrees


# Create the document
def update_create_document(document_name, count, route, route_id):
    subcollection_path = f'jeeps_historical/{document_name}/timeline'
    doc_ref_realtime = db.collection(collection_name).document(document_name)
    doc_ref_historical = db.collection(subcollection_path).document()

    embark = random.choice([True, False])
    passenger_count = random.randint(0, 16)
    random_x = random.uniform(-0.00004, 0.00004)
    random_y = random.uniform(-0.00004, 0.00004)

    if count == 0: pos1 = route[len(route)-1]
    else: pos1 = route[count-1]
    bearing = calculate_bearing(pos1, route[count])
    # Define the data to be added to the document


    data = {
        'acceleration': [random.uniform(0, 150) for _ in range(3)],
        'air_qual': random.uniform(0, 1200),
        'device_id': document_name,
        'disembark': not embark,
        'embark': embark,
        'gyroscope': [random.uniform(0, 360) for _ in range(3)],
        'is_active': True,
        'location': firestore_v1.GeoPoint(route[count][0] + random_x, route[count][1] + random_y),
        'passenger_count': passenger_count,
        'route_id': route_id,
        'slots_remaining': 16 - passenger_count, 
        'speed': random.uniform(0, 150),
        'temp': random.uniform(26, 33),
        'timestamp': firestore.SERVER_TIMESTAMP,
        'bearing': bearing
    }
    # Set the data in the document
    doc_ref_realtime.set(data)
    doc_ref_historical.set(data)
    print(f"Document updated and created successfully for {document_name}.")

count0 = random.randint(0, len(ikot)-1)
count1 = random.randint(0, len(toki)-1)
count2 = random.randint(0, len(katip)-1)
count3 = random.randint(0, len(philcoa)-1)
count4 = random.randint(0, len(sm)-1)


while True:
    if count0 >= len(ikot): count0 = 0
    update_create_document('jeep1', count0, ikot, 0)
    if count1 >= len(toki): count1 = 0
    update_create_document('jeep2', count1, toki, 1)
    if count2 >= len(katip): count2 = 0
    update_create_document('jeep3', count2, katip, 2)
    if count3 >= len(philcoa): count3 = 0
    update_create_document('jeep4', count3, philcoa, 3)
    if count4 >= len(sm): count4 = 0
    update_create_document('jeep5', count4, sm, 4)
    count0+=1
    count1+=1
    count2+=1
    count3+=1
    count4+=1
    time.sleep(5)